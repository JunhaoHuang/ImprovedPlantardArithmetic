#include <stdint.h>
#include <stdio.h>
#include "params.h"
#include "fq.h"
#include "ntt.h"
#include "sendfn.h"
#define printcycles(S, U) send_unsignedll_r((S), (U))
#define print(S) hal_send_rstr((S))

const int32_t zetas[128] = {11183355, 821417389, 680507122, 4241846363, 2696306771, 904733380, 2149999903, 2224928378, 2391560360, 1069687858, 1859791854, 451248355, 2368075316, 3210181910, 3437204006, 2710285964, 604460311, 3810168879, 3065916637, 350038996, 3571963428, 2085695615, 3464603225, 213042904, 1059063672, 3485292431, 449011684, 1411898506, 219193749, 1496892000, 3889011528, 3253796992, 4157971204, 3896280709, 1327464180, 1724473265, 3477464082, 3949401642, 506046792, 1735656619, 1841898487, 854967452, 839869924, 1988400431, 4277073929, 403719098, 4065149362, 84993495, 2259037610, 2717555144, 23485045, 2154473245, 3488088269, 2367516148, 508283463, 2758933556, 2058855564, 1328582515, 2015799649, 957854313, 1609843881, 4211651305, 2825474515, 2016917985, 2630324979, 782834816, 3718465372, 390858240, 1093172903, 4057880181, 3168803498, 176137834, 2431261269, 4200467951, 2772353581, 1336410863, 2920533028, 2556514839, 3553510893, 86111830, 3871118161, 3657516090, 1267074065, 4160767042, 30195058, 929336760, 2266865958, 2004057127, 842665762, 1120012954, 4246319704, 1366046753, 2591742406, 2458660487, 4162444546, 1647867286, 2138257381, 3295175404, 3840923104, 2728179331, 2714759306, 2904317164, 3058088289, 1063537014, 281820534, 83875159, 2545890653, 2956319763, 1804434249, 3042431592, 2640389998, 1092613735, 3044668263, 3513809985, 3805695537, 1643953112, 1777594198, 3648010239, 148179448, 1220103977, 1488504485, 2385968683, 1669674827, 3667021941, 1537152077, 1019921931, 549661874, 214720407};

const int32_t zetas_asm[256] = {3912496573, 1289999942, 1113302941, 2478231358, 4214447144, 1401833487, 3536176694, 3844278110, 4263094736, 3069830811, 4288257284, 3937099952, 3779414654, 3993575893, 1699869885, 1555045444, 3567490086, 39141741, 223667091, 3543445874, 725240540, 3232548619, 11183355, 821417389, 680507122, 4241846363, 2696306771, 904733380, 2149999903, 2224928378, 616202833, 2333406917, 234291277, 2386527851, 914798399, 50325096, 1548894599, 2391560360, 1069687858, 1859791854, 451248355, 2368075316, 3210181910, 3437204006, 2710285964, 779479809, 1128400470, 847139104, 586566944, 4213887976, 2836098702, 435032491, 604460311, 3810168879, 3065916637, 350038996, 3571963428, 2085695615, 3464603225, 213042904, 129726913, 2950168918, 1082548716, 116866055, 4074096045, 24603380, 2666111713, 1059063672, 3485292431, 449011684, 1411898506, 219193749, 1496892000, 3889011528, 3253796992, 829804904, 2698543442, 1928010316, 3499271624, 3188933536, 1188790584, 2705812622, 4157971204, 3896280709, 1327464180, 1724473265, 3477464082, 3949401642, 506046792, 1735656619, 1678621511, 568114409, 2214304192, 2719791815, 3059206624, 572587751, 4260858065, 1841898487, 854967452, 839869924, 1988400431, 4277073929, 403719098, 4065149362, 84993495, 1531001232, 3796748853, 1845812661, 4001404241, 986371867, 390299073, 2468166339, 2259037610, 2717555144, 23485045, 2154473245, 3488088269, 2367516148, 508283463, 2758933556, 353394003, 1251417369, 1292795781, 88907669, 4168036223, 470819225, 651430400, 2058855564, 1328582515, 2015799649, 957854313, 1609843881, 4211651305, 2825474515, 2016917985, 2833862031, 2231079223, 2811495322, 3542886706, 1667997324, 2554278168, 351157332, 2630324979, 782834816, 3718465372, 390858240, 1093172903, 4057880181, 3168803498, 176137834, 3706722850, 469700890, 139791932, 1209479790, 1433706047, 2515136428, 3918647418, 2431261269, 4200467951, 2772353581, 1336410863, 2920533028, 2556514839, 3553510893, 86111830, 1500806174, 1042288640, 105682701, 3450064864, 2151677406, 1630533087, 2939544731, 3871118161, 3657516090, 1267074065, 4160767042, 30195058, 929336760, 2266865958, 2004057127, 3719024540, 1575734650, 3639063555, 2881950455, 4232340511, 3997490067, 1343120876, 842665762, 1120012954, 4246319704, 1366046753, 2591742406, 2458660487, 4162444546, 1647867286, 1203328945, 2522405608, 801846518, 3373458886, 3611664337, 3196761885, 82197656, 2138257381, 3295175404, 3840923104, 2728179331, 2714759306, 2904317164, 3058088289, 1063537014, 767178119, 1661287312, 1977217076, 303628075, 3618374349, 3228634445, 3926475766, 281820534, 83875159, 2545890653, 2956319763, 1804434249, 3042431592, 2640389998, 1092613735, 3644096065, 2132106536, 2628647476, 3939895791, 2911027177, 3089960849, 612847827, 3044668263, 3513809985, 3805695537, 1643953112, 1777594198, 3648010239, 148179448, 1220103977, 2874122107, 674915445, 1683654021, 2439089617, 3486969934, 3678205296, 3446709858, 1488504485, 2385968683, 1669674827, 3667021941, 1537152077, 1019921931, 549661874, 214720407,};
const int32_t zetas_inv_asm[257] = {4080246890, 3745305423, 3275045366, 2757815220, 627945356, 2625292470, 1908998614, 2806462812, 848257439, 616762001, 807997363, 1855877680, 2611313276, 3620051852, 1420845190, 3074863320, 4146787849, 646957058, 2517373099, 2651014185, 489271760, 781157312, 1250299034, 3682119470, 1205006448, 1383940120, 355071506, 1666319821, 2162860761, 650871232, 3202353562, 1654577299, 1252535705, 2490533048, 1338647534, 1749076644, 4211092138, 4013146763, 368491531, 1066332852, 676592948, 3991339222, 2317750221, 2633679985, 3527789178, 3231430283, 1236879008, 1390650133, 1580207991, 1566787966, 454044193, 999791893, 2156709916, 4212769641, 1098205412, 683302960, 921508411, 3493120779, 1772561689, 3091638352, 2647100011, 132522751, 1836306810, 1703224891, 2928920544, 48647593, 3174954343, 3452301535, 2951846421, 297477230, 62626786, 1413016842, 655903742, 2719232647, 575942757, 2290910170, 2028101339, 3365630537, 4264772239, 134200255, 3027893232, 637451207, 423849136, 1355422566, 2664434210, 2143289891, 844902433, 4189284596, 3252678657, 2794161123, 4208855467, 741456404, 1738452458, 1374434269, 2958556434, 1522613716, 94499346, 1863706028, 376319879, 1779830869, 2861261250, 3085487507, 4155175365, 3825266407, 588244447, 4118829463, 1126163799, 237087116, 3201794394, 3904109057, 576501925, 3512132481, 1664642318, 3943809965, 1740689129, 2626969973, 752080591, 1483471975, 2063888074, 1461105266, 2278049312, 1469492782, 83315992, 2685123416, 3337112984, 2279167648, 2966384782, 2236111733, 3643536897, 3824148072, 126931074, 4206059628, 3002171516, 3043549928, 3941573294, 1536033741, 3786683834, 1927451149, 806879028, 2140494052, 4271482252, 1577412153, 2035929687, 1826800958, 3904668224, 3308595430, 293563056, 2449154636, 498218444, 2763966065, 4209973802, 229817935, 3891248199, 17893368, 2306566866, 3455097373, 3439999845, 2453068810, 34109232, 3722379546, 1235760673, 1575175482, 2080663105, 3726852888, 2616345786, 2559310678, 3788920505, 345565655, 817503215, 2570494032, 2967503117, 398686588, 136996093, 1589154675, 3106176713, 1106033761, 795695673, 2366956981, 1596423855, 3465162393, 1041170305, 405955769, 2798075297, 4075773548, 2883068791, 3845955613, 809674866, 3235903625, 1628855584, 4270363917, 220871252, 4178101242, 3212418581, 1344798379, 4165240384, 4081924393, 830364072, 2209271682, 723003869, 3944928301, 1229050660, 484798418, 3690506986, 3859934806, 1458868595, 81079321, 3708400353, 3447828193, 3166566827, 3515487488, 1584681333, 857763291, 1084785387, 1926891981, 3843718942, 2435175443, 3225279439, 1903406937, 2746072698, 4244642201, 3380168898, 1908439446, 4060676020, 1961560380, 3678764464, 2070038919, 2144967394, 3390233917, 1598660526, 53120934, 3614460175, 3473549908, 4283783942, 1062418678, 3569726757, 751521423, 4071300206, 4255825556, 727477211, 2739921853, 2595097412, 301391404, 515552643, 357867345, 6710013, 1225136486, 31872561, 450689187, 758790603, 2893133810, 80520153, 1816735939, 3181664356, 3004967355, 3118478403, 3225838606, 2156709916};

extern void ntt_fast(int16_t *, const int32_t *);
extern void invntt_fast(int16_t *, const int32_t *);
void ntt(int16_t a[768])
{
  ntt_fast(a, zetas_asm);
}

void invntt(int16_t a[768])
{
  invntt_fast(a, zetas_inv_asm);
}

void ntt_pack(int16_t b[768], const int16_t a[768]) {
  unsigned i, j, k;
  int16_t buf[96];

  for(i = 0; i < 768/96; ++i) {
    for(j = 0; j < 96; ++j)
      buf[j] = a[96*i + j];

    for(j = 0; j < 6; ++j)
      for(k = 0; k < 16; ++k)
        b[96*i + 16*j + k] = buf[6*k + j];
  }
}

void ntt_unpack(int16_t b[768], const int16_t a[768]) {
  unsigned j, k, l;
  int16_t buf[96];

  for(j = 0; j < 768/96; ++j) {
    for(k = 0; k < 6; ++k)
      for(l = 0; l < 16; ++l)
        buf[6*l + k] = a[96*j + 16*k + l];

    for(k = 0; k < 96; ++k)
      b[96*j + k] = buf[k];
  }
}